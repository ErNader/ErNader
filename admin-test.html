<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†</title>
    <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { color: #333; margin-bottom: 10px; }
        .test-button { margin: 5px; padding: 8px 15px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .user-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
        .user-item { padding: 5px; border-bottom: 1px solid #eee; }
        .role-badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; color: white; }
        .role-admin { background-color: #dc3545; }
        .role-teacher { background-color: #007bff; }
        .role-student { background-color: #28a745; }
        .role-coordinator { background-color: #ffc107; color: #212529; }
        .role-supervisor { background-color: #6f42c1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ØªØ³Øª Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†</h1>
        
        <!-- ØªØ³Øª ÙˆØ±ÙˆØ¯ -->
        <div class="test-section">
            <h3>ğŸ” ØªØ³Øª ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</h3>
            <p>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯: Ú©Ø¯ Ù…Ù„ÛŒ: 1234567890ØŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: admin123</p>
            <button onclick="testAdminLogin()" class="btn btn-primary test-button">ØªØ³Øª ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</button>
            <div id="login-status"></div>
        </div>

        <!-- ØªØ³Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
        <div class="test-section">
            <h3>ğŸ‘¥ ØªØ³Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
            <button onclick="testUserManagement()" class="btn btn-success test-button">Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
            <button onclick="testAddUser()" class="btn btn-info test-button">Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª</button>
            <button onclick="testListUsers()" class="btn btn-warning test-button">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
            <div id="user-management-status"></div>
            <div id="user-list" class="user-list"></div>
        </div>

        <!-- ØªØ³Øª Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù -->
        <div class="test-section">
            <h3>ğŸ­ ØªØ³Øª Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù</h3>
            <button onclick="testStudentRole()" class="btn btn-success test-button">ØªØ³Øª Ù†Ù‚Ø´ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
            <button onclick="testTeacherRole()" class="btn btn-primary test-button">ØªØ³Øª Ù†Ù‚Ø´ Ø§Ø³ØªØ§Ø¯</button>
            <button onclick="testCoordinatorRole()" class="btn btn-warning test-button">ØªØ³Øª Ù†Ù‚Ø´ Ø±Ø§Ø¨Ø·</button>
            <button onclick="testSupervisorRole()" class="btn btn-info test-button">ØªØ³Øª Ù†Ù‚Ø´ Ù…Ø³Ø¦ÙˆÙ„ Ø³Ø·ÙˆØ­</button>
            <div id="role-test-status"></div>
        </div>

        <!-- ØªØ³Øª Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† -->
        <div class="test-section">
            <h3>âš™ï¸ ØªØ³Øª Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†</h3>
            <button onclick="testProgramManagement()" class="btn btn-success test-button">Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§</button>
            <button onclick="testSurveyManagement()" class="btn btn-info test-button">Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒâ€ŒÙ‡Ø§</button>
            <button onclick="testGradeManagement()" class="btn btn-warning test-button">Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø±Ø§Øª</button>
            <button onclick="testAttendanceManagement()" class="btn btn-primary test-button">Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</button>
            <div id="admin-features-status"></div>
        </div>

        <!-- ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ -->
        <div class="test-section">
            <h3>ğŸ—„ï¸ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</h3>
            <button onclick="testDatabaseConnection()" class="btn btn-secondary test-button">ØªØ³Øª Ø§ØªØµØ§Ù„</button>
            <button onclick="testDatabaseTables()" class="btn btn-secondary test-button">Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„</button>
            <div id="database-status"></div>
        </div>

        <!-- ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ -->
        <div class="test-section">
            <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</h3>
            <div id="current-status"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    <script>
        let currentUser = null;
        let isSupabaseConnected = false;

        // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        async function testDatabaseConnection() {
            const statusDiv = document.getElementById('database-status');
            statusDiv.innerHTML = '<div class="status warning">Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„...</div>';
            
            try {
                const { data, error } = await supabaseClient.from('users').select('*').limit(1);
                if (error) {
                    statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${error.message}</div>`;
                } else {
                    isSupabaseConnected = true;
                    statusDiv.innerHTML = '<div class="status success">Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ÙˆÙÙ‚ Ø§Ø³Øª!</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡: ${error.message}</div>`;
            }
        }

        // ØªØ³Øª Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        async function testDatabaseTables() {
            const statusDiv = document.getElementById('database-status');
            statusDiv.innerHTML = '<div class="status warning">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯Ø§ÙˆÙ„...</div>';
            
            const tables = ['users', 'registrations', 'programs', 'attendance', 'grades'];
            let results = '';
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabaseClient.from(table).select('count').limit(1);
                    if (error) {
                        results += `<div class="status error">âŒ ${table}: ${error.message}</div>`;
                    } else {
                        results += `<div class="status success">âœ… ${table}: Ù…ÙˆØ¬ÙˆØ¯</div>`;
                    }
                } catch (err) {
                    results += `<div class="status error">âŒ ${table}: ${err.message}</div>`;
                }
            }
            
            statusDiv.innerHTML = results;
        }

        // ØªØ³Øª ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†
        async function testAdminLogin() {
            const statusDiv = document.getElementById('login-status');
            statusDiv.innerHTML = '<div class="status warning">Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª ÙˆØ±ÙˆØ¯...</div>';
            
            try {
                const result = await supabaseHelper.loginUser('1234567890', 'admin123');
                if (result.success) {
                    currentUser = result.user;
                    statusDiv.innerHTML = `<div class="status success">ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${currentUser.full_name}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        // ØªØ³Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        async function testUserManagement() {
            const statusDiv = document.getElementById('user-management-status');
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="status error">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>';
                return;
            }
            
            try {
                showUserManagement();
                statusDiv.innerHTML = '<div class="status success">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§Ø² Ø´Ø¯</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        // ØªØ³Øª Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø±
        async function testAddUser() {
            const statusDiv = document.getElementById('user-management-status');
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="status error">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>';
                return;
            }
            
            try {
                addNewUserModal();
                statusDiv.innerHTML = '<div class="status success">ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø² Ø´Ø¯</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        // ØªØ³Øª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        async function testListUsers() {
            const statusDiv = document.getElementById('user-management-status');
            const userListDiv = document.getElementById('user-list');
            
            try {
                const { data, error } = await supabaseClient.from('users').select('*').order('created_at', { ascending: false });
                
                if (error) {
                    statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${error.message}</div>`;
                    return;
                }
                
                if (data && data.length > 0) {
                    let userList = '<h4>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</h4>';
                    data.forEach(user => {
                        userList += `
                            <div class="user-item">
                                <strong>${user.full_name}</strong> 
                                <span class="role-badge role-${user.role}">${user.role}</span>
                                <br>
                                <small>Ú©Ø¯ Ù…Ù„ÛŒ: ${user.national_id} | Ø§ÛŒÙ…ÛŒÙ„: ${user.email}</small>
                            </div>
                        `;
                    });
                    userListDiv.innerHTML = userList;
                    statusDiv.innerHTML = `<div class="status success">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${data.length}</div>`;
                } else {
                    userListDiv.innerHTML = '<div class="status warning">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                    statusDiv.innerHTML = '<div class="status warning">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        // ØªØ³Øª Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        async function testStudentRole() {
            testRole('student', '1111111111', '123456');
        }

        async function testTeacherRole() {
            testRole('teacher', '2222222222', '123456');
        }

        async function testCoordinatorRole() {
            testRole('coordinator', '3333333333', '123456');
        }

        async function testSupervisorRole() {
            testRole('supervisor', '4444444444', '123456');
        }

        async function testRole(role, nationalId, password) {
            const statusDiv = document.getElementById('role-test-status');
            statusDiv.innerHTML = `<div class="status warning">Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ù†Ù‚Ø´ ${role}...</div>`;
            
            try {
                const result = await supabaseHelper.loginUser(nationalId, password);
                if (result.success) {
                    statusDiv.innerHTML = `<div class="status success">ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù†Ù‚Ø´ ${role} Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ù†Ù‚Ø´ ${role}: ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ù†Ù‚Ø´ ${role}: ${error.message}</div>`;
            }
        }

        // ØªØ³Øª Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
        async function testProgramManagement() {
            const statusDiv = document.getElementById('admin-features-status');
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="status error">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>';
                return;
            }
            
            try {
                showProgramManagement();
                statusDiv.innerHTML = '<div class="status success">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø² Ø´Ø¯</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        async function testSurveyManagement() {
            const statusDiv = document.getElementById('admin-features-status');
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="status error">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>';
                return;
            }
            
            try {
                showSurveyManagement();
                statusDiv.innerHTML = '<div class="status success">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§Ø² Ø´Ø¯</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        async function testGradeManagement() {
            const statusDiv = document.getElementById('admin-features-status');
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="status error">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>';
                return;
            }
            
            try {
                showGradeManagement();
                statusDiv.innerHTML = '<div class="status success">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø±Ø§Øª Ø¨Ø§Ø² Ø´Ø¯</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        async function testAttendanceManagement() {
            const statusDiv = document.getElementById('admin-features-status');
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="status error">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</div>';
                return;
            }
            
            try {
                showAttendanceManagement();
                statusDiv.innerHTML = '<div class="status success">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ø¨Ø§Ø² Ø´Ø¯</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Ø®Ø·Ø§: ${error.message}</div>`;
            }
        }

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ
        function updateCurrentStatus() {
            const statusDiv = document.getElementById('current-status');
            let status = '';
            
            status += `<div class="status ${isSupabaseConnected ? 'success' : 'error'}">`;
            status += `Ø§ØªØµØ§Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: ${isSupabaseConnected ? 'Ø¨Ø±Ù‚Ø±Ø§Ø±' : 'Ù‚Ø·Ø¹'}`;
            status += '</div>';
            
            if (currentUser) {
                status += `<div class="status success">Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ: ${currentUser.full_name} (${currentUser.role})</div>`;
            } else {
                status += '<div class="status warning">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
            }
            
            statusDiv.innerHTML = status;
        }

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentStatus();
            testDatabaseConnection();
        });

        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡
        setInterval(updateCurrentStatus, 5000);
    </script>
</body>
</html>