<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تست سیستم حضور و غیاب و مدیریت</title>
    <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            background-color: #f8f9fa;
        }
        .test-section h3 { 
            color: #333; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .test-button { 
            margin: 5px; 
            padding: 10px 20px; 
            font-size: 14px;
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            font-weight: bold;
        }
        .status.success { 
            background-color: #d4edda; 
            border: 2px solid #c3e6cb; 
            color: #155724; 
        }
        .status.error { 
            background-color: #f8d7da; 
            border: 2px solid #f5c6cb; 
            color: #721c24; 
        }
        .status.warning { 
            background-color: #fff3cd; 
            border: 2px solid #ffeaa7; 
            color: #856404; 
        }
        .status.info { 
            background-color: #d1ecf1; 
            border: 2px solid #bee5eb; 
            color: #0c5460; 
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .feature-card h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        .feature-card p {
            color: #666;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 تست سیستم حضور و غیاب و مدیریت</h1>
        <p>این صفحه برای تست قابلیت‌های جدید سیستم حضور و غیاب و مدیریت طراحی شده است.</p>
        
        <!-- تست ورود -->
        <div class="test-section">
            <h3>🔐 تست ورود</h3>
            <p>ابتدا با یکی از حساب‌های زیر وارد شوید:</p>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>مدیر سیستم</h4>
                    <p>کد ملی: 1234567890</p>
                    <p>رمز عبور: admin123</p>
                    <button onclick="testLogin('1234567890', 'admin123')" class="btn btn-primary test-button">ورود مدیر</button>
                </div>
                <div class="feature-card">
                    <h4>رابط (احمد رضایی)</h4>
                    <p>کد ملی: 1111111111</p>
                    <p>رمز عبور: 123456</p>
                    <button onclick="testLogin('1111111111', '123456')" class="btn btn-success test-button">ورود رابط</button>
                </div>
                <div class="feature-card">
                    <h4>دانش‌آموز (علی احمدی)</h4>
                    <p>کد ملی: 3333333333</p>
                    <p>رمز عبور: 123456</p>
                    <button onclick="testLogin('3333333333', '123456')" class="btn btn-info test-button">ورود دانش‌آموز</button>
                </div>
            </div>
            <div id="login-status"></div>
        </div>

        <!-- تست مدیریت حضور و غیاب -->
        <div class="test-section">
            <h3>📊 تست مدیریت حضور و غیاب</h3>
            <p>این بخش فقط برای مدیران قابل دسترسی است:</p>
            <button onclick="testAttendanceManagement()" class="btn btn-primary test-button">مدیریت حضور و غیاب</button>
            <button onclick="testAttendanceEdit()" class="btn btn-success test-button">ویرایش حضور و غیاب</button>
            <button onclick="testAttendanceAnalytics()" class="btn btn-info test-button">تحلیل حضور و غیاب</button>
            <button onclick="testRecordAttendance()" class="btn btn-warning test-button">ثبت حضور و غیاب</button>
            <div id="attendance-test-status"></div>
        </div>

        <!-- تست مدیریت نمرات -->
        <div class="test-section">
            <h3>📝 تست مدیریت نمرات</h3>
            <p>این بخش فقط برای مدیران قابل دسترسی است:</p>
            <button onclick="testGradesOverview()" class="btn btn-primary test-button">نمای کلی نمرات</button>
            <button onclick="testGradesEdit()" class="btn btn-success test-button">ویرایش نمرات</button>
            <button onclick="testGradesAnalytics()" class="btn btn-info test-button">تحلیل نمرات</button>
            <div id="grades-test-status"></div>
        </div>

        <!-- تست گزارش‌ها -->
        <div class="test-section">
            <h3>📈 تست گزارش‌ها</h3>
            <p>این بخش فقط برای مدیران قابل دسترسی است:</p>
            <button onclick="testGeneralReports()" class="btn btn-primary test-button">گزارش‌های کلی</button>
            <button onclick="testFinancialReports()" class="btn btn-success test-button">گزارش‌های مالی</button>
            <button onclick="testPerformanceReports()" class="btn btn-info test-button">گزارش‌های عملکرد</button>
            <div id="reports-test-status"></div>
        </div>

        <!-- تست تنظیمات -->
        <div class="test-section">
            <h3>⚙️ تست تنظیمات سیستم</h3>
            <p>این بخش فقط برای مدیران قابل دسترسی است:</p>
            <button onclick="testSystemSettings()" class="btn btn-primary test-button">تنظیمات سیستم</button>
            <button onclick="testRequestManagement()" class="btn btn-success test-button">مدیریت درخواست‌ها</button>
            <div id="settings-test-status"></div>
        </div>

        <!-- تست برنامه‌های مختلف -->
        <div class="test-section">
            <h3>🎯 تست حضور و غیاب بر اساس برنامه</h3>
            <p>تست کنید که حضور و غیاب برای هر برنامه به صورت جداگانه ثبت می‌شود:</p>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>کلاس‌های تقویتی ریاضی</h4>
                    <p>برنامه ID: 1</p>
                    <button onclick="testProgramAttendance(1)" class="btn btn-primary test-button">مشاهده حضور</button>
                </div>
                <div class="feature-card">
                    <h4>برنامه‌نویسی</h4>
                    <p>برنامه ID: 2</p>
                    <button onclick="testProgramAttendance(2)" class="btn btn-success test-button">مشاهده حضور</button>
                </div>
                <div class="feature-card">
                    <h4>اردوهای تفریحی</h4>
                    <p>برنامه ID: 3</p>
                    <button onclick="testProgramAttendance(3)" class="btn btn-info test-button">مشاهده حضور</button>
                </div>
            </div>
            <div id="program-attendance-status"></div>
        </div>

        <!-- وضعیت فعلی -->
        <div class="test-section">
            <h3>📊 وضعیت فعلی سیستم</h3>
            <div id="current-system-status"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    <script>
        let currentTestUser = null;

        // تست ورود
        async function testLogin(nationalId, password) {
            const statusDiv = document.getElementById('login-status');
            statusDiv.innerHTML = '<div class="status warning">در حال ورود...</div>';
            
            try {
                const result = await supabaseHelper.loginUser(nationalId, password);
                if (result.success) {
                    currentTestUser = result.user;
                    statusDiv.innerHTML = `<div class="status success">ورود موفق! خوش آمدید ${currentTestUser.full_name} (${currentTestUser.role})</div>`;
                    updateSystemStatus();
                } else {
                    statusDiv.innerHTML = `<div class="status error">خطا در ورود: ${result.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        // تست مدیریت حضور و غیاب
        function testAttendanceManagement() {
            const statusDiv = document.getElementById('attendance-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showAttendanceManagement();
                statusDiv.innerHTML = '<div class="status success">پنل مدیریت حضور و غیاب باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testAttendanceEdit() {
            const statusDiv = document.getElementById('attendance-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                editAttendanceModal();
                statusDiv.innerHTML = '<div class="status success">پنل ویرایش حضور و غیاب باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testAttendanceAnalytics() {
            const statusDiv = document.getElementById('attendance-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showAttendanceAnalytics();
                statusDiv.innerHTML = '<div class="status success">پنل تحلیل حضور و غیاب باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testRecordAttendance() {
            const statusDiv = document.getElementById('attendance-test-status');
            if (!currentTestUser || (currentTestUser.role !== 'admin' && currentTestUser.role !== 'coordinator')) {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران و رابط‌ها می‌توانند حضور و غیاب ثبت کنند</div>';
                return;
            }
            
            try {
                recordAttendance();
                statusDiv.innerHTML = '<div class="status success">فرم ثبت حضور و غیاب باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        // تست مدیریت نمرات
        function testGradesOverview() {
            const statusDiv = document.getElementById('grades-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showGradesOverview();
                statusDiv.innerHTML = '<div class="status success">پنل نمای کلی نمرات باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testGradesEdit() {
            const statusDiv = document.getElementById('grades-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                editGrades();
                statusDiv.innerHTML = '<div class="status success">پنل ویرایش نمرات باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testGradesAnalytics() {
            const statusDiv = document.getElementById('grades-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showGradeAnalytics();
                statusDiv.innerHTML = '<div class="status success">پنل تحلیل نمرات باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        // تست گزارش‌ها
        function testGeneralReports() {
            const statusDiv = document.getElementById('reports-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showGeneralReports();
                statusDiv.innerHTML = '<div class="status success">پنل گزارش‌های کلی باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testFinancialReports() {
            const statusDiv = document.getElementById('reports-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showFinancialReports();
                statusDiv.innerHTML = '<div class="status success">پنل گزارش‌های مالی باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testPerformanceReports() {
            const statusDiv = document.getElementById('reports-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showPerformanceReports();
                statusDiv.innerHTML = '<div class="status success">پنل گزارش‌های عملکرد باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        // تست تنظیمات
        function testSystemSettings() {
            const statusDiv = document.getElementById('settings-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showSystemSettings();
                statusDiv.innerHTML = '<div class="status success">پنل تنظیمات سیستم باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        function testRequestManagement() {
            const statusDiv = document.getElementById('settings-test-status');
            if (!currentTestUser || currentTestUser.role !== 'admin') {
                statusDiv.innerHTML = '<div class="status error">فقط مدیران می‌توانند به این بخش دسترسی داشته باشند</div>';
                return;
            }
            
            try {
                showRequestManagement();
                statusDiv.innerHTML = '<div class="status success">پنل مدیریت درخواست‌ها باز شد</div>';
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        // تست حضور و غیاب بر اساس برنامه
        function testProgramAttendance(programId) {
            const statusDiv = document.getElementById('program-attendance-status');
            
            try {
                // فیلتر کردن حضور و غیاب بر اساس برنامه
                const programAttendance = attendance.filter(a => a.programId === programId);
                const program = programs.find(p => p.id === programId);
                
                if (programAttendance.length === 0) {
                    statusDiv.innerHTML = `<div class="status warning">هیچ رکورد حضور و غیابی برای برنامه "${program ? program.name : 'نامشخص'}" یافت نشد</div>`;
                } else {
                    const presentCount = programAttendance.filter(a => a.status === 'present').length;
                    const absentCount = programAttendance.filter(a => a.status === 'absent').length;
                    const lateCount = programAttendance.filter(a => a.status === 'late').length;
                    const excusedCount = programAttendance.filter(a => a.status === 'excused').length;
                    
                    statusDiv.innerHTML = `
                        <div class="status success">
                            <h4>حضور و غیاب برنامه: ${program ? program.name : 'نامشخص'}</h4>
                            <p>کل رکوردها: ${programAttendance.length}</p>
                            <p>حاضر: ${presentCount} | غایب: ${absentCount} | تأخیر: ${lateCount} | عذر موجه: ${excusedCount}</p>
                            <p>نرخ حضور: ${Math.round((presentCount / programAttendance.length) * 100)}%</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">خطا: ${error.message}</div>`;
            }
        }

        // بروزرسانی وضعیت سیستم
        function updateSystemStatus() {
            const statusDiv = document.getElementById('current-system-status');
            
            let status = '';
            
            if (currentTestUser) {
                status += `<div class="status success">کاربر فعلی: ${currentTestUser.full_name} (${currentTestUser.role})</div>`;
            } else {
                status += '<div class="status warning">هیچ کاربری وارد نشده است</div>';
            }
            
            status += `<div class="status info">تعداد دانش‌آموزان: ${students.length}</div>`;
            status += `<div class="status info">تعداد برنامه‌ها: ${programs.length}</div>`;
            status += `<div class="status info">تعداد رکوردهای حضور و غیاب: ${attendance.length}</div>`;
            status += `<div class="status info">تعداد نمرات: ${grades.length}</div>`;
            
            statusDiv.innerHTML = status;
        }

        // مقداردهی اولیه
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemStatus();
        });
    </script>
</body>
</html>